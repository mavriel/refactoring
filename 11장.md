# 11. 조건부 로직 간소화

## 11.1 질의 함수와 변경 함수 분리하기 (Separate Query from Modifier)

### 언제/의견/주의사항

- 좋은 API는 데이터를 갱신하는 함수와 그저 조회만 하는 함수를 명확히 구분한다.
- 질의함수에 부수효과가 없도록 만들면 버그없는 프로그램을 만드는데 유용하다.

### 절차

1. 대상 함수를 복제하고 질의 목적에 충실한 이름을 짓는다.
2. 새 질의 함수에서 부수효과를 모두 제거한다.
3. 정적 검사 수행
4. 원래 함수를 호출하는 곳을 모두 찾아, 반환값을 사용하면 질의 함수를 호출하도록 하고, 바로 아래 원래 함수 호출하도록 수정후 테스트
5. 원래 함수에서 질의 관련 코드 제거
6. 테스트

## 11.2 함수 매개변수화하기 (Parameterize Function)

### 언제/의견/주의사항

- 값 하나 때문에 여러개로 나뉜 함수가 존재시
- 두 함수의 로직이 아주 비슷하고 리터럴 값만 다를때, 다른 값만 매개변수로 받아서 처리
- 매개변수 값만 바꿔서 여러 곳에서 사용 가능해짐
- **테스트중요** 이 파트는 좀 애매한듯. 이책의 대부분 실수없이 기계적으로 하는 내용이 대부분인데, 이건 실수가 생길듯

### 절차

1. 비슷한 함수 하나 선택
2. 함수 선언 바꾸기로 리터럴들을 매개변수로 추가
3. 이 함수를 호출하는 모든 곳에 적절한 리터럴 값 추가
4. 테스트
5. 매개변수로 받은 값을 사용하도록 함수 본문 수정. 수정할때마다 테스트
6. 비슷한 다른 함수를 호출하는 코드를 찾아 매개변수화된 함수를 호출하도록 하나씩 수정. 수정할때마다 테스트

## 11.3 플래그 인수 제거하기 (Remove Flag Argument)

### 언제/의견/주의사항

- 플래그 인수가 있으면 함수들의 기능 차이가 잘 드러나지 않아서, 함수를 어떻게 호출해야 하는지 이해하기 어려워 진다.
  - 호출하는 위치에서 특히 true/false만 가지고 함수가 뭘 할지 판단하기 어렵다.
- 플래그 인수는 함수내에서 그 인수를 가지고 제어 흐름을 결정하는데 사용되는 경우임

### 절차

1. 매개변수로 주어질 수 있는 값 각각에 대응하는 명시적 함수 생성
2. 원래 함수를 호출하는 코드들을 찾아서 명시적 함수 호출하도록 수정

## 11.4 객체 통째로 넘기기 (Preserve Whole Object)

### 언제/의견/주의사항

- 하나의 레코드에서 값 두어개를 가져와 인수로 넘기는 코드를 발견시 레코드 통째로 전달
- 레코드 통째로 넘기면 변화에 대응도 쉽고, 매개변수 목록이 짧아져 이해하기 쉬워진다.

### 절차

1. 매개변수들을 원하는 형태로 받는 빈 함수 생성 (검색쉬운 이름으로)
2. 새 함수에서 원래 함수 호출하도록 한 후 새 매개변수와 원래 매개변수 매핑
3. 정적 검사
4. 모든 호출자가 새 함수 호출하도록 수정. 각각 테스트
5. 원래 함수 인라인
6. 새 함수 이름 수정

## 11.5 매개변수를 질의 함수로 바꾸기 (Replace Parameter with Query)

### 언제/의견/주의사항

- 매개변수의 중복도 줄이는 것이 좋다
- 매개변수를 제거해 피호출 함수에 원치않는 의존성이 생길때는 수행하면 안 된다.

### 절차

1. 필요시 매개변수의 값을 계산하는 코드를 별도 함수로 추출
2. 함수 본문에서 대상 매개변수의 참조를 찾아 수정. 수정시마다 테스트
3. 함수 선언 바꾸기로 대상 매개변수 제거

## 11.6 질의 함수를 매개변수로 바꾸기 (Replace Query with Parameter)

### 언제/의견/주의사항

- 함수내에서 전역변수를 참조하거나, 제거하길 원하는 원소를 참조하는 경우
- 보통은 의존관계를 바꿀 때 발생
- 순수함수로 변경되기 때문에 테스트하거나 다루기 쉬워진다.
- 호출자가 복잡해지는 단점이 생긴다.
- 개인적으로는 이 리팩토링은 안 좋아함.

### 절차

1. 변수 추출하기로 질의 코드를 함수 본문의 나머지 코드와 분리
2. 함수 본문 중 해당 질의를 호출하지 않는 코드들을 별도 함수로 추출 (검색쉬운 이름 사용)
3. 방금 만든 변수를 인라인해서 제거
4. 원래 함수도 인라인
5. 새 함수의 이름 원래 함수로 변경

## 11.7 세터 제거하기 (Remove Setting Method)

### 언제/의견/주의사항

- 클래스를 불변으로 만들면 편하기 때문에
- 오직 생성자에서만 필드가 설정되고 수정하지 않겠다는 의도를 알림

### 절차

1. 설정할 값을 생성자에서 받지 않는다면, 생성자에 추가(함수선언 바꾸기)후에 생성자에서 세터 호출
2. 생성자 밖의 세터 호출 삭제 후, 생성자 쓰도록 변경. 각각 테스트
3. 세터 메서드 인라인. 가능하면 해당 필드 불변으로 만든다.
4. 테스트

## 11.8 생성자를 팩터리 함수로 바꾸기 (Replace Constructor with Factory Function)

### 언제/의견/주의사항

- 생성자의 사용에 제약이 많음. 팩토리 함수를 써서, 제약을 벗어날 수 있음

### 절차

1. 팩터리 함수를 만든다. 팩터리 함수 본문에서 원래 생성자 호출
2. 생성자를 호출하던 코드를 팩터리 함수 호출로 변경
3. 각각 테스트
4. 생성자의 가시 범위가 최소가 되도록 제한

## 11.9 함수를 명령으로 바꾸기 (Replace Function with Command)

### 언제/의견/주의사항

- 함수를 그 함수만을 위한 객체안으로 챕슐화하면 유용해 지는 경우 (이 객체를 명령객체 or 명령이라고 함 - 메서드를 요청해 실행하는 것이 객체의 목적)
- 되돌리기 같은 보조 연산, 생명주기를 제어하는 매개변수 제공 등등
- 일급함수를 지원하지 않는 프로그래밍에서 명령을 이용해 일급함수 흉내
- 자바스크립트에서는 그냥 함수를 쓰면 됨

### 절차

1. 대상 함수의 기능을 옮길 빈 클래스를 만든다. (이름은 함수명이 기초)
2. 빈 클래스로 함수 이동
3. 함수의 인수들 각각은 명령의 필드로 만들어 생성자를 통해 설정할지 고민

## 11.10 명령을 함수로 바꾸기 (Replace Command with Function)

### 언제/의견/주의사항

- 로직이 복잡하지 않은데, 명령을 사용했다면 단순한 함수로 변경이 더 좋다.
- 아마도 이 리팩토링을 하는 경우는 거의 안 생길듯. (대부분 명령패턴을 안 쓰니깐...)

### 절차

1. 명령을 생성하는 코드와 명령의 실행 메서드를 호출하는 코드를 함께 함수로 추출
2. 명령의 실행 함수가 호촐하는 보조 메서드들 인라인
3. 함수 선언 바꾸기를 적용해 생성자의 매개변수 모두를 명령의 실행 메서드로 옮긴다.
4. 명령의 실행 메서드에서 참조하는 필드들 대신 대응하는 매개변수를 사용하게 변경. 바꿀때마다 테스트
5. 생성자 호출과 명령의 실행 메서드 호출을 호출자안으로 인라인
6. 테스트
7. 죽은 코드 제거하기로 명령 클래스 제거

## 11.11 수정된 값 반환하기 (Return Modified Value)

### 언제/의견/주의사항

- 같은 데이터 블록을 읽고 수정하는 코드가 여러 곳이라면 데이터가 수정되는 흐름과 코드의 흐름을 일치시키기 어렵다.
- 데이터가 수정됨을 알려 주기 위해, 변수를 갱신하는 함수라면 수정된 값을 반환하여 호출자가 그 값을 변수에 담도록 함
- 값 하나를 계산하는 경우에는 유용. 여러개를 갱산하면 효과적이지 않다.
- 함수 옮기기의 준비 작업을 적절

### 절차

1. 함수가 수정된 값을 반환하게 하여 호출자가 그 값을 자신의 변수에 저장하게 한다
2. 테스트
3. 피호출 함수 안에 반환할 값을 가리키는 새로운 변수 선언
4. 테스트
5. 계산이 선언과 동시에 이뤄지도록 통합
6. 테스트
7. 피호출 함수의 변수 이름을 새 역할에 어울리도록 바꿈
8. 테스트

## 11.12 오류 코드를 예외로 바꾸기 (Replace Error Code with exception)

### 언제/의견/주의사항

- 예외를 사용하면 오류코드를 일일이 검사하거나 오류를 식별해 콜스택 위로 던지는 일을 신경쓰지 않아도 된다.
- 프로그램의 정상 동작 범주에 들지 않는 오루를 나타낼 때만 쓰여야 한다.

### 절차

1. 콜스택 상위에 해당 예외를 처리할 예외 핸들러 작성
2. 테스트
3. 해당 오류 코드를 대체할 예외와 그 밖에 예외를 구분할 식별 방법 찾는다
4. 정적 검사 수행
5. catch절을 수정해 직접 처리할 수 있는 예외는 적절히 대처하고 그렇지 않은 예외는 다시 던진다
6. 테스트
7. 오류 코드를 반환하는 곳 모두에서 예외를 던지도록 수정. 각각 테스트
8. 모두 수정했으면 그 오류 코드를 콜스택 위로 전달하는 코드 모두 제거. 각각 테스트

## 11.13 예외를 사전확인으로 바꾸기 (Replace Exception with Precheck)

### 언제/의견/주의사항

- 함수 수행시 문제가 될 수 있는 조건을 미리 검사가 가능하다면, 예외대신 조건 검사
- 자바스크립트의 경우 예외자체를 거의 발생시키지 않는 언어라서, 크게 쓰일 일은 없을듯

### 절차

1. 예외를 유발하는 상황을 검사할 수 있는 조건문 추가. catch 블록의 코드를 조건문의 조건절중 하나로 옮기고, 남은 try블록의 코드는 다른 조건절로 옮긴다.
2. catch 블록에 어서션 추가하고 테스트
3. try/catch 제거
4. 테스트
